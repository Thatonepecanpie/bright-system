<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Bright System (Single‑File)</title>
<style>
  :root{--bg:#0a0a0a;--card:#151515;--muted:#999;--text:#f4f4f4;--accent:#4da3ff;--ok:#37c97b;--warn:#ffb020;--danger:#ff6b6b;--hair:#262626}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  header{position:sticky;top:0;background:linear-gradient(to bottom, rgba(10,10,10,.95), rgba(10,10,10,.7));backdrop-filter:saturate(1.2) blur(6px);z-index:10}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--hair)}
  .brand{font-weight:700;letter-spacing:.2px}
  .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--hair);color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:8px;overflow:auto;padding:8px 12px;border-bottom:1px solid var(--hair)}
  .tab{padding:10px 12px;border-radius:10px;border:1px solid var(--hair);color:var(--muted);white-space:nowrap;cursor:pointer;user-select:none}
  .tab.active{background:var(--card);color:var(--text);border-color:#333}
  main{padding:16px;max-width:980px;margin:0 auto}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--hair);border-radius:14px;padding:14px}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{color:var(--muted);font-size:12px;text-align:center}
  .day{aspect-ratio:1/1;border:1px solid var(--hair);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:4px;justify-content:flex-start}
  .day header{display:flex;justify-content:space-between;align-items:center;position:static;background:none;border:none;padding:0}
  .day .num{font-size:13px;color:var(--muted)}
  .today{outline:2px solid var(--accent)}
  .pill{display:inline-block;font-size:10px;padding:2px 6px;border-radius:999px;background:#1e1e1e;border:1px solid #333;margin-top:auto;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--hair);background:#1a1a1a;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#001933;font-weight:700}
  .btn.warn{background:var(--warn);color:#271a00;border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.block{width:100%}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  input,select,textarea{width:100%;background:#101010;color:#fff;border:1px solid var(--hair);border-radius:10px;padding:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .list{display:grid;gap:10px}
  .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--hair);border-radius:12px;background:#0f0f0f}
  .item small{color:var(--muted)}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:640px){.split{grid-template-columns:1fr}}
  dialog{border:none;border-radius:16px;background:var(--card);color:#fff;width:min(560px,92vw);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--hair)}
  .modal-c{padding:14px;display:grid;gap:12px;max-height:75vh;overflow:auto}
  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .muted{color:var(--muted)}
  .note{font-size:12px;color:var(--muted)}
  .tag{font-size:11px;border:1px solid var(--hair);border-radius:999px;padding:4px 8px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="flex" style="gap:10px">
      <div class="brand">✨ Bright System</div>
      <div id="modeBadge" class="badge">User Mode</div>
    </div>
    <div class="flex">
      <button id="toggleModeBtn" class="btn">Unlock Admin</button>
    </div>
  </div>
  <div class="tabs" id="tabs"></div>
</header>

<main>
  <section id="Calendar" class="view"></section>
  <section id="Clients" class="view" hidden></section>
  <section id="Packages" class="view" hidden></section>
  <section id="Employees" class="view" hidden></section>
  <section id="Reports" class="view" hidden></section>
  <section id="Settings" class="view" hidden></section>
</main>

<dialog id="dayDialog">
  <div class="modal-h">
    <div>
      <strong id="dlgDate"></strong>
      <div class="note">Create or view appointments</div>
    </div>
    <button class="btn" onclick="dayDialog.close()">Close</button>
  </div>
  <div class="modal-c" id="dayDialogBody"></div>
</dialog>

<dialog id="promptDialog">
  <div class="modal-h"><strong id="promptTitle">Enter</strong></div>
  <div class="modal-c">
    <input id="promptInput">
    <div class="flex" style="justify-content:flex-end">
      <button class="btn ghost" onclick="promptDialog.close()">Cancel</button>
      <button class="btn primary" id="promptOk">OK</button>
    </div>
  </div>
</dialog>

<script>
/* --------------------------- Storage & State --------------------------- */
const DEFAULT_DATA = {
  adminPasscode: "1234",
  services: [
    {id: uid(), name:"Exterior Foam Wash", basePrice:60, active:true},
    {id: uid(), name:"Standard Detail", basePrice:150, active:true},
    {id: uid(), name:"Premium Detail", basePrice:200, active:true},
    {id: uid(), name:"Ceramic Coating", basePrice:600, active:true},
  ],
  employees: [
    {id: uid(), name:"Alex M.", active:true},
    {id: uid(), name:"Sam R.", active:true},
  ],
  clients: [
    {id: uid(), name:"Jane Doe", email:"jane@example.com", phone:"555-1111"},
    {id: uid(), name:"John Smith", email:"john@example.com", phone:"555-2222"},
  ],
  appointments: [] // {id, dateStr, time, clientId, serviceId, employeeId, price, notes}
};

const store = {
  key: "bright_system_v1",
  load(){
    try{
      const raw = localStorage.getItem(this.key);
      return raw ? JSON.parse(raw) : structuredClone(DEFAULT_DATA);
    }catch(e){ return structuredClone(DEFAULT_DATA); }
  },
  save(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};

let data = store.load();
let mode = "user"; // 'user' | 'admin'

/* --------------------------- Utilities --------------------------- */
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function fmtMoney(n){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(Number(n||0)); }
function todayISO(d=new Date()){ d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function ymd(date){ return date.toISOString().slice(0,10); }
function parseTimeStr(s){ const [h,m]=s.split(":").map(Number); const d=new Date(); d.setHours(h||9,m||0,0,0); return d; }
function downloadFile(filename, text){
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(text);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}

/* --------------------------- Router/Tabs --------------------------- */
const views = ["Calendar","Clients","Packages","Employees","Reports","Settings"];
const tabsEl = document.getElementById('tabs');
views.forEach((v,i)=>{
  const el = document.createElement('button');
  el.className = 'tab' + (i===0?' active':'');
  el.textContent = v;
  el.onclick = ()=>showView(v);
  tabsEl.appendChild(el);
});
function showView(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.textContent===name));
  document.querySelectorAll('.view').forEach(v=> v.hidden = (v.id!==name));
  render[name]();
}

/* --------------------------- Mode Toggle --------------------------- */
const modeBadge = document.getElementById('modeBadge');
const toggleModeBtn = document.getElementById('toggleModeBtn');
toggleModeBtn.onclick = async ()=>{
  if(mode==="admin"){ mode="user"; modeBadge.textContent="User Mode"; toggleModeBtn.textContent="Unlock Admin"; renderAll(); return; }
  const pass = await promptModal("Unlock Admin","Enter passcode","");
  if(pass===data.adminPasscode){ mode="admin"; modeBadge.textContent="Admin Mode"; toggleModeBtn.textContent="Lock Admin"; renderAll(); }
  else if(pass!==null){ alert("Incorrect passcode"); }
};

/* --------------------------- Prompt Modal --------------------------- */
const promptDialog = document.getElementById('promptDialog');
const promptInput = document.getElementById('promptInput');
const promptTitle = document.getElementById('promptTitle');
const promptOk = document.getElementById('promptOk');
function promptModal(title, placeholder, value=""){
  return new Promise(res=>{
    promptTitle.textContent = title;
    promptInput.placeholder = placeholder;
    promptInput.value = value;
    promptOk.onclick = ()=>{ promptDialog.close(); res(promptInput.value); };
    promptDialog.onclose = ()=>{};
    promptDialog.showModal();
    promptInput.focus();
  });
}

/* --------------------------- Calendar --------------------------- */
const Calendar = {
  current: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
  mount(){
    const el = document.getElementById('Calendar');
    el.innerHTML = `
      <div class="row">
        <div class="card" style="flex:1 1 320px">
          <div class="flex" style="justify-content:space-between;margin-bottom:8px">
            <h3 id="calTitle"></h3>
            <div class="flex">
              <button class="btn" id="prevM">&#x25C0;</button>
              <button class="btn" id="nextM">&#x25B6;</button>
            </div>
          </div>
          <div class="grid-7" id="calGrid"></div>
        </div>
        <div class="card" style="flex:1 1 260px">
          <h3>Quick Add</h3>
          <div class="split">
            <div>
              <label>Date</label>
              <input type="date" id="qaDate" value="${todayISO()}">
            </div>
            <div>
              <label>Start Time</label>
              <input type="time" id="qaTime" value="09:00">
            </div>
          </div>
          <div>
            <label>Client</label>
            <select id="qaClient"></select>
          </div>
          <div class="split">
            <div>
              <label>Service</label>
              <select id="qaService"></select>
            </div>
            <div>
              <label>Employee</label>
              <select id="qaEmp"></select>
            </div>
          </div>
          <div class="split">
            <div>
              <label>Price Paid</label>
              <input type="number" id="qaPrice" step="0.01" placeholder="0.00">
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn primary block" id="qaAdd">Add</button>
            </div>
          </div>
          <div>
            <label>Notes</label>
            <input id="qaNotes" placeholder="Optional">
          </div>
          <p class="note">Price auto-fills from service; override allowed in Admin mode only.</p>
        </div>
      </div>
    `;
    el.querySelector('#prevM').onclick = ()=>{ Calendar.current.setMonth(Calendar.current.getMonth()-1); render.Calendar(); };
    el.querySelector('#nextM').onclick = ()=>{ Calendar.current.setMonth(Calendar.current.getMonth()+1); render.Calendar(); };
    render.Calendar();
  }
};

function openDayDialog(dateISO){
  const dlg = document.getElementById('dayDialog');
  document.getElementById('dlgDate').textContent = new Date(dateISO).toDateString();
  const body = document.getElementById('dayDialogBody');
  const dayAppts = data.appointments.filter(a=>a.dateStr===dateISO).sort((a,b)=>a.time.localeCompare(b.time));
  const list = dayAppts.map(a=>{
    const svc = data.services.find(s=>s.id===a.serviceId)?.name || "";
    const emp = data.employees.find(e=>e.id===a.employeeId)?.name || "";
    const cli = data.clients.find(c=>c.id===a.clientId)?.name || "";
    return `<div class="item">
      <div style="flex:1">
        <div><strong>${a.time}</strong> • ${svc} <span class="tag">${fmtMoney(a.price)}</span></div>
        <small>${cli} • ${emp}</small>
      </div>
      ${mode==="admin"?`<button class="btn warn" onclick="editAppt('${a.id}')">Edit</button>`:""}
      <button class="btn" onclick="deleteAppt('${a.id}')">Delete</button>
    </div>`;
  }).join('') || `<div class="muted">No appointments.</div>`;

  const options = `
    <div class="split">
      <div>
        <label>Time</label>
        <input type="time" id="dlgTime" value="09:00">
      </div>
      <div>
        <label>Client</label>
        <select id="dlgClient"></select>
      </div>
    </div>
    <div class="split">
      <div>
        <label>Service</label>
        <select id="dlgService"></select>
      </div>
      <div>
        <label>Employee</label>
        <select id="dlgEmp"></select>
      </div>
    </div>
    <div class="split">
      <div>
        <label>Price</label>
        <input type="number" id="dlgPrice" step="0.01" placeholder="0.00" ${mode==="user"?"disabled":""}>
      </div>
      <div>
        <label>Notes</label>
        <input id="dlgNotes" placeholder="Optional">
      </div>
    </div>
    <button class="btn primary" id="dlgAdd">Add Appointment</button>
  `;

  body.innerHTML = `
    <h3>Appointments</h3>
    <div class="list">${list}</div>
    <h3>New</h3>
    ${options}
  `;
  // populate selects
  const cs = body.querySelector('#dlgClient'), ss = body.querySelector('#dlgService'), es = body.querySelector('#dlgEmp');
  cs.innerHTML = optionsFor(data.clients);
  ss.innerHTML = optionsFor(data.services.filter(s=>s.active));
  es.innerHTML = optionsFor(data.employees.filter(e=>e.active));
  ss.onchange = ()=>{
    const svc = data.services.find(s=>s.id===ss.value);
    if(svc){ body.querySelector('#dlgPrice').value = svc.basePrice; }
  };
  body.querySelector('#dlgAdd').onclick = ()=>{
    const time = body.querySelector('#dlgTime').value || "09:00";
    const clientId = cs.value; const serviceId = ss.value; const employeeId = es.value;
    if(!clientId || !serviceId || !employeeId){ alert("Select client, service and employee"); return; }
    const price = Number(body.querySelector('#dlgPrice').value || (data.services.find(s=>s.id===serviceId)?.basePrice||0));
    const notes = body.querySelector('#dlgNotes').value.trim();
    data.appointments.push({id:uid(), dateStr:dateISO, time, clientId, serviceId, employeeId, price, notes});
    store.save(data); render.Calendar(); openDayDialog(dateISO);
  };

  dlg.showModal();
}

function optionsFor(list){
  return `<option value=""></option>` + list.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
}

function editAppt(id){
  const a = data.appointments.find(a=>a.id===id);
  if(!a) return;
  const svc = data.services.find(s=>s.id===a.serviceId);
  const emp = data.employees.find(e=>e.id===a.employeeId);
  const cli = data.clients.find(c=>c.id===a.clientId);
  // Simple edit via prompt chain (keeps single-file).
  const time = prompt("Time (HH:MM)", a.time); if(time===null) return;
  const price = mode==="admin" ? prompt("Price", String(a.price)) : String(a.price);
  if(price===null) return;
  a.time = time; a.price = Number(price);
  store.save(data); render.Calendar(); document.getElementById('dayDialog').close(); openDayDialog(a.dateStr);
}

function deleteAppt(id){
  if(!confirm("Delete this appointment?")) return;
  data.appointments = data.appointments.filter(a=>a.id!==id);
  store.save(data); render.Calendar(); document.getElementById('dayDialog').close();
}

/* --------------------------- CRUD Screens --------------------------- */
const render = {
  Calendar(){
    const calTitle = document.getElementById('calTitle');
    const grid = document.getElementById('calGrid');
    const month = Calendar.current.getMonth(), year = Calendar.current.getFullYear();
    calTitle.textContent = Calendar.current.toLocaleString(undefined,{month:'long',year:'numeric'});
    grid.innerHTML = '';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
      const el = document.createElement('div'); el.textContent=d.slice(0,1); el.className='dow'; grid.appendChild(el);
    });
    const first = new Date(year, month, 1);
    const start = new Date(first); start.setDate(1 - first.getDay());
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const dayEl = document.createElement('div'); dayEl.className='day';
      const inMonth = d.getMonth()===month;
      if(ymd(d)===todayISO()) dayEl.classList.add('today');
      dayEl.style.opacity = inMonth?1:.45;
      dayEl.innerHTML = `<header><div class="num">${d.getDate()}</div>${inMonth?`<button class="btn" style="padding:2px 6px" onclick="openDayDialog('${ymd(d)}')">+</button>`:''}</header>`;
      // dots/pills
      const appts = data.appointments.filter(a=>a.dateStr===ymd(d));
      appts.slice(0,2).forEach(a=>{
        const svc = data.services.find(s=>s.id===a.serviceId)?.name || "";
        const pill = document.createElement('div'); pill.className='pill'; pill.textContent = `${a.time} ${svc}`;
        dayEl.appendChild(pill);
      });
      if(appts.length>2){
        const more = document.createElement('div'); more.className='pill'; more.textContent = `+${appts.length-2} more`;
        dayEl.appendChild(more);
      }
      grid.appendChild(dayEl);
    }
    // Quick Add selects
    const qaC = document.getElementById('qaClient');
    const qaS = document.getElementById('qaService');
    const qaE = document.getElementById('qaEmp');
    qaC.innerHTML = optionsFor(data.clients);
    qaS.innerHTML = optionsFor(data.services.filter(s=>s.active));
    qaE.innerHTML = optionsFor(data.employees.filter(e=>e.active));
    qaS.onchange = ()=>{
      const svc = data.services.find(s=>s.id===qaS.value);
      if(svc) document.getElementById('qaPrice').value = svc.basePrice;
    };
    document.getElementById('qaAdd').onclick = ()=>{
      const dateStr = document.getElementById('qaDate').value || todayISO();
      const time = document.getElementById('qaTime').value || "09:00";
      const clientId = qaC.value, serviceId = qaS.value, employeeId = qaE.value;
      if(!clientId || !serviceId || !employeeId){ alert("Select client, service and employee"); return; }
      let price = document.getElementById('qaPrice').value;
      if(!price){ price = data.services.find(s=>s.id===serviceId)?.basePrice || 0; }
      if(mode!=="admin"){ /* prevent price override */ }
      data.appointments.push({id:uid(), dateStr, time, clientId, serviceId, employeeId, price:Number(price), notes: document.getElementById('qaNotes').value.trim()});
      store.save(data); render.Calendar();
    };
  },
  Clients(){
    const el = document.getElementById('Clients');
    el.innerHTML = `
      <div class="card">
        <h3>Add Client</h3>
        <div class="split">
          <div><label>Name</label><input id="cName" placeholder="Full name"></div>
          <div><label>Email</label><input id="cEmail" placeholder="you@example.com"></div>
        </div>
        <div class="split">
          <div><label>Phone</label><input id="cPhone" placeholder="(555) 123-4567"></div>
          <div><label>&nbsp;</label><button class="btn primary block" id="cAdd">Save</button></div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>All Clients</h3>
        <div class="list" id="cList"></div>
      </div>
    `;
    el.querySelector('#cAdd').onclick = ()=>{
      const name = el.querySelector('#cName').value.trim(); if(!name) return;
      const email = el.querySelector('#cEmail').value.trim(); const phone = el.querySelector('#cPhone').value.trim();
      data.clients.push({id:uid(), name, email: email||undefined, phone: phone||undefined});
      store.save(data); render.Clients();
    };
    const list = el.querySelector('#cList');
    list.innerHTML = data.clients.map(c=>`
      <div class="item">
        <div style="flex:1">
          <div><strong>${c.name}</strong></div>
          <small>${c.email||'—'} • ${c.phone||'—'}</small>
        </div>
        <button class="btn" onclick="delClient('${c.id}')">Delete</button>
      </div>
    `).join('') || `<div class="muted">No clients yet.</div>`;
  },
  Packages(){
    const el = document.getElementById('Packages');
    el.innerHTML = `
      <div class="card">
        <h3>Packages ${mode==='admin'?'(Admin)':''}</h3>
        ${mode==='admin'?`
        <div class="split">
          <div><label>Name</label><input id="pName" placeholder="Premium Detail"></div>
          <div><label>Base Price</label><input id="pPrice" type="number" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="flex" style="justify-content:flex-end"><button class="btn primary" id="pAdd">Save</button></div>`
        :`<div class="note">Admin mode required to add/edit packages.</div>`}
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Active</h3>
        <div class="list" id="pActive"></div>
        ${mode==='admin'?'<h3>Inactive</h3><div class="list" id="pInactive"></div>':''}
      </div>
    `;
    if(mode==='admin'){
      el.querySelector('#pAdd').onclick = ()=>{
        const name = el.querySelector('#pName').value.trim(); const price = Number(el.querySelector('#pPrice').value||0);
        if(!name) return;
        data.services.push({id:uid(), name, basePrice:price, active:true});
        store.save(data); render.Packages();
      };
    }
    const act = el.querySelector('#pActive');
    act.innerHTML = data.services.filter(s=>s.active).map(s=>`
      <div class="item">
        <div style="flex:1">${s.name} <small class="muted">• ${fmtMoney(s.basePrice)}</small></div>
        ${mode==='admin'?`<button class="btn" onclick="deactivatePkg('${s.id}')">Deactivate</button>`:''}
      </div>`).join('') || `<div class="muted">None.</div>`;
    if(mode==='admin'){
      const ina = el.querySelector('#pInactive');
      ina.innerHTML = data.services.filter(s=>!s.active).map(s=>`
        <div class="item">
          <div style="flex:1"><span class="muted">${s.name}</span></div>
          <button class="btn" onclick="activatePkg('${s.id}')">Activate</button>
        </div>`).join('') || `<div class="muted">None.</div>`;
    }
  },
  Employees(){
    const el = document.getElementById('Employees');
    el.innerHTML = `
      <div class="card">
        <h3>Employees ${mode==='admin'?'(Admin)':''}</h3>
        ${mode==='admin'?`
        <div class="split">
          <div><label>Full Name</label><input id="eName" placeholder="Chris P."></div>
          <div><label>&nbsp;</label><button class="btn primary block" id="eAdd">Add</button></div>
        </div>`:`<div class="note">Admin mode required to add/remove employees.</div>`}
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Active</h3>
        <div class="list" id="eActive"></div>
        ${mode==='admin'?'<h3>Inactive</h3><div class="list" id="eInactive"></div>':''}
      </div>
    `;
    if(mode==='admin'){
      el.querySelector('#eAdd').onclick = ()=>{
        const name = el.querySelector('#eName').value.trim(); if(!name) return;
        data.employees.push({id:uid(), name, active:true}); store.save(data); render.Employees();
      };
    }
    const act = el.querySelector('#eActive');
    act.innerHTML = data.employees.filter(e=>e.active).map(e=>`
      <div class="item">
        <div style="flex:1">${e.name}</div>
        ${mode==='admin'?`<button class="btn" onclick="deactEmp('${e.id}')">Deactivate</button>`:''}
      </div>
    `).join('') || `<div class="muted">None.</div>`;
    if(mode==='admin'){
      const ina = el.querySelector('#eInactive');
      ina.innerHTML = data.employees.filter(e=>!e.active).map(e=>`
        <div class="item">
          <div style="flex:1"><span class="muted">${e.name}</span></div>
          <button class="btn" onclick="actEmp('${e.id}')">Activate</button>
        </div>
      `).join('') || `<div class="muted">None.</div>`;
    }
  },
  Reports(){
    const el = document.getElementById('Reports');
    const rows = data.appointments.map(a=>{
      const d = a.dateStr, t = a.time;
      const s = data.services.find(s=>s.id===a.serviceId)?.name || "";
      const e = data.employees.find(e=>e.id===a.employeeId)?.name || "";
      const c = data.clients.find(c=>c.id===a.clientId)?.name || "";
      const p = a.price;
      const n = (a.notes||'').replaceAll(',',' ');
      return [d,t,s,p,e,c,n];
    });
    const csv = ["Date,Time,Service,Price Paid,Employee,Client,Notes", ...rows.map(r=>r.join(','))].join('\n');
    el.innerHTML = `
      <div class="card">
        <h3>Export</h3>
        <p class="note">Exports all appointments currently stored (CSV for Excel).</p>
        <div class="flex">
          <button class="btn primary" id="exp">Generate CSV</button>
          <div class="tag">Rows: ${rows.length}</div>
        </div>
      </div>
    `;
    el.querySelector('#exp').onclick = ()=> downloadFile(`BrightSystem_Report_${todayISO()}.csv`, csv);
  },
  Settings(){
    const el = document.getElementById('Settings');
    el.innerHTML = `
      <div class="card">
        <h3>Security</h3>
        <div class="split">
          <div><label>Admin Passcode</label><input id="sPass" value="${data.adminPasscode}"></div>
          <div><label>&nbsp;</label><button class="btn primary block" id="sSave">Save</button></div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Data</h3>
        <div class="flex" style="flex-wrap:wrap">
          <button class="btn" id="seed">Seed Demo Data</button>
          <button class="btn warn" id="reset">Reset to Factory</button>
        </div>
        <p class="note">All data is stored locally on your device using Safari's localStorage.</p>
      </div>
    `;
    el.querySelector('#sSave').onclick = ()=>{
      data.adminPasscode = el.querySelector('#sPass').value; store.save(data); alert('Saved.');
    };
    el.querySelector('#seed').onclick = ()=>{ data = structuredClone(DEFAULT_DATA); store.save(data); renderAll(); alert('Seeded.'); };
    el.querySelector('#reset').onclick = ()=>{ if(confirm('Reset all data?')){ data = structuredClone(DEFAULT_DATA); store.save(data); renderAll(); } };
  }
};

function renderAll(){ Object.values(render).forEach(fn=>fn()); }

/* --------------------------- Actions for CRUD helpers --------------------------- */
function delClient(id){ if(!confirm("Delete client?")) return; data.clients = data.clients.filter(c=>c.id!==id); store.save(data); render.Clients(); }
function deactivatePkg(id){ data.services.find(s=>s.id===id).active=false; store.save(data); render.Packages(); }
function activatePkg(id){ data.services.find(s=>s.id===id).active=true; store.save(data); render.Packages(); }
function deactEmp(id){ data.employees.find(e=>e.id===id).active=false; store.save(data); render.Employees(); }
function actEmp(id){ data.employees.find(e=>e.id===id).active=true; store.save(data); render.Employees(); }

/* --------------------------- Boot --------------------------- */
Calendar.mount();
render.Clients(); render.Packages(); render.Employees(); render.Reports(); render.Settings();

</script>
</html>
